<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>××©×—×§ ×–×™×”×•×™ ×ª×•×•×™×</title>

<style>
:root{
  --bg:#0f1220;
  --panel:#1a1f36;
  --staff:#ffffff;
  --good:#3ddc97;
  --bad:#ff6b6b;
  --text:#e9ecff;
  --accent:#6c7cff;
}

body{
  margin:0;
  padding:18px;
  font-family:system-ui,Arial;
  background:var(--bg);
  color:var(--text);
}

button{
  width:100%;
  padding:16px;
  font-size:20px;
  font-weight:800;
  border-radius:14px;
  border:0;
  background:var(--accent);
  color:white;
}

#stage{
  margin-top:14px;
  border-radius:16px;
  overflow:hidden;
  background:var(--panel);
}

canvas{
  width:100%;
  height:auto;
  display:block;
}

#noteBox{
  margin-top:14px;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:42px;
  font-weight:900;
  border-radius:14px;
}

.good{ color:var(--good); animation:pulse 0.45s ease; }
.bad{ color:var(--bad); }

@keyframes pulse{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.25); }
  100%{ transform:scale(1); }
}
</style>
</head>

<body>

<button id="btn">ğŸ¤ ×”×ª×—×œ</button>

<div id="stage">
  <canvas id="cv" width="900" height="420"></canvas>
</div>

<div id="noteBox"></div>

<audio playsinline></audio>

<script>
(() => {

/* ---------- ×ª×•×•×™× ×‘×¢×‘×¨×™×ª ---------- */
const HEB = ["×“×•","×¨×”","××™","×¤×”","×¡×•×œ","×œ×”","×¡×™"];
const LETTERS = ["C","D","E","F","G","A","B"];

/* ---------- YIN ---------- */
const FFT=2048;
const buf=new Float32Array(FFT);
const RMS_GATE=0.005;
const PROB_GATE=0.7;
const CENTS_OK=35;
const STABLE=6;

let audioCtx,analyser,stream,raf,running=false;
let stableCount=0,lastMidi=null;

/* ---------- UI ---------- */
const btn=document.getElementById("btn");
const box=document.getElementById("noteBox");
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

/* ---------- ×™×¢×“ ---------- */
let target=null;

/* ---------- ×”×ª×—×œ×” ---------- */
btn.onclick=async()=>{
 if(running){stop();return;}
 stream=await navigator.mediaDevices.getUserMedia({audio:true});
 audioCtx=new AudioContext();
 const src=audioCtx.createMediaStreamSource(stream);
 analyser=audioCtx.createAnalyser();
 analyser.fftSize=FFT;
 src.connect(analyser);
 running=true;
 btn.textContent="â¹ ×¢×¦×•×¨";
 nextTarget();
 loop();
};

/* ---------- ×œ×•×œ××” ---------- */
function loop(){
 analyser.getFloatTimeDomainData(buf);
 const r=yin(buf,audioCtx.sampleRate);
 if(r.freq && r.prob>0.6){
   const midi=freqToMidi(r.freq);
   const cents=centsOff(r.freq,midiToFreq(midi));
   showPlayed(midi,cents);
   check(midi,cents,r.prob);
 } else {
   box.textContent="";
   box.className="";
 }
 draw();
 raf=requestAnimationFrame(loop);
}

/* ---------- ×‘×“×™×§×” ---------- */
function check(midi,cents,prob){
 if(midi===target.midi && Math.abs(cents)<CENTS_OK && prob>PROB_GATE){
   stableCount++;
   if(stableCount>=STABLE){
     box.className="good";
     setTimeout(()=>{ box.textContent=""; nextTarget(); },700);
     stableCount=0;
   }
 } else {
   stableCount=0;
 }
}

/* ---------- ×ª×• ×× ×•×’×Ÿ ---------- */
function showPlayed(midi,cents){
 const name=hebrewName(midi);
 box.textContent=name;
 box.className=(midi===target.midi && Math.abs(cents)<CENTS_OK)?"good":"bad";
}

/* ---------- ×™×¢×“ ×—×“×© ---------- */
function nextTarget(){
 const midi=36+Math.floor(Math.random()*49); // C2â€“C6
 target={midi};
}

/* ---------- ×¦×™×•×¨ ---------- */
function draw(){
 ctx.clearRect(0,0,cv.width,cv.height);
 drawStaff();
 drawClef();
 drawNote(target.midi);
}

function drawStaff(){
 const y=140,g=18;
 ctx.strokeStyle=varColor("--staff");
 ctx.lineWidth=2;
 for(let i=0;i<5;i++){
  ctx.beginPath();
  ctx.moveTo(80,y+i*g);
  ctx.lineTo(cv.width-40,y+i*g);
  ctx.stroke();
 }
}

function drawClef(){
 ctx.fillStyle=varColor("--staff");
 ctx.font="110px serif";
 ctx.fillText(target.midi<60?"ğ„¢":"ğ„",50,260);
}

function drawNote(m){
 const x=360;
 const base=(m<60)?43:64;
 const dy=((m-base)/2)*9;
 const y=212-dy;
 ctx.beginPath();
 ctx.ellipse(x,y,16,12,0,0,Math.PI*2);
 ctx.fillStyle=varColor("--staff");
 ctx.fill();
}

/* ---------- ×©××•×ª ---------- */
function hebrewName(m){
 const pc=m%12;
 const octave=Math.floor(m/12)-1;
 const map={0:0,2:1,4:2,5:3,7:4,9:5,11:6};
 const letter=map[pc];
 const acc=[1,3,6,8,10].includes(pc)?((Math.random()<0.5)?"â™¯":"â™­"):"";
 return `${HEB[letter]}${acc}${octave}`;
}

/* ---------- YIN ---------- */
function yin(x,sr){
 let mean=0;
 for(let v of x)mean+=v;
 mean/=x.length;
 let rms=0;
 const d=[];
 for(let i=0;i<x.length;i++){const v=x[i]-mean;d[i]=v;rms+=v*v;}
 rms=Math.sqrt(rms/x.length);
 if(rms<RMS_GATE)return{};
 const n=d.length;
 const maxTau=n/2;
 const df=new Float32Array(maxTau);
 for(let t=1;t<maxTau;t++){
  let s=0;
  for(let i=0;i<maxTau;i++){const z=d[i]-d[i+t];s+=z*z;}
  df[t]=s;
 }
 let sum=0;
 const cm=new Float32Array(maxTau);
 cm[0]=1;
 for(let t=1;t<maxTau;t++){sum+=df[t];cm[t]=df[t]*t/(sum||1);}
 for(let t=2;t<maxTau;t++){
  if(cm[t]<0.12){
   const f=sr/t;
   return{freq:f,prob:1-cm[t]};
  }
 }
 return{};
}

/* ---------- helpers ---------- */
function freqToMidi(f){return Math.round(69+12*Math.log2(f/440));}
function midiToFreq(m){return 440*Math.pow(2,(m-69)/12);}
function centsOff(f,r){return 1200*Math.log2(f/r);}
function varColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v);}

function stop(){
 cancelAnimationFrame(raf);
 stream.getTracks().forEach(t=>t.stop());
 audioCtx.close();
 running=false;
 btn.textContent="ğŸ¤ ×”×ª×—×œ";
 box.textContent="";
}

})();
</script>
</body>
</html>
